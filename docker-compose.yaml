services:
  simple:
    profiles:
      - simple
    build:
      context: .
      dockerfile: docker/simple/Dockerfile
    ports:
      - "8080:80"
      - "8001-8005:8001-8005"
      - "81:81"
    volumes:
      - ./docker/simple/nginx/sites:/etc/nginx/conf.d
      - ./docker/simple/www:/var/www/
    networks:
      - redis-server
    environment:
      - PYTHONWARNINGS=ignore
      - L5_SWAGGER_CONST_HOST="http://127.0.0.1:81"
    command: supervisord -c /etc/supervisord.conf

  laravel-medium:
    profiles:
      - medium
    build:
      context: .
      dockerfile: docker/medium/scripts/laravel/Dockerfile
    ports:
      - "81:81"
    volumes:
      - ./docker/medium/nginx/sites:/etc/nginx/conf.d
      - ./docker/medium/www:/var/www/
    environment:
      EXEC_PROVIDER: nginx-sites-medium:9000
      SECRET_PROVIDER: apikey_2025
    networks:
      - backend
      - redis-server
    command: ./artisan serve --host=0.0.0.0 --port=81

  nginx-sites-medium:
    profiles:
      - medium
    build:
      context: .
      dockerfile: docker/medium/scripts/backend/go/Dockerfile
#      dockerfile: docker/medium/scripts/backend/php/Dockerfile
    ports:
      - "8080:80"
      - "8001-8005:8001-8005"
    volumes:
      - ./docker/medium/nginx/sites:/etc/nginx/conf.d
      - ./docker/medium/www/html:/var/www/html
    expose:
      - "9000"
    environment:
      - BACKEND_PORT=9000
      - SEC_TOKEN=apikey_2025
      - PYTHONWARNINGS=ignore
    networks:
      - backend
    command: supervisord -c /etc/supervisord.conf

  hard:
    profiles:
      - hard
    build:
      context: .

  docker-socket-proxy:
    profiles:
#      - medium
      - hard
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: 1
      IMAGES: 0
      AUTH: 0
      INFO: 1
      NETWORKS: 1
      SERVICES: 1
      VOLUMES: 0
      POST: 0
    ports:
      - "2375:2375"

  redis:
    profiles:
      - simple
      - medium
      - hard
    image: redis:7-alpine
    container_name: my-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - redis-server
    command:   [
      "redis-server",
      "--appendonly", "no",
      "--save", "",
      "--maxmemory", "256mb",
      "--maxmemory-policy", "allkeys-lru"
    ]

volumes:
  redis-data:

networks:
  backend:
  redis-server:
